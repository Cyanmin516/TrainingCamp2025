# Linux FTP
- speacher: pro.Chi
- date: 2025-9-25
- class 9

#FTP #實務 #Email #smtp #pop3 #postfix #imap #mail_server #firewall

## 實務
DNS: 8.8.8.8 google dns
     1.1.1.1 cloudflare dns
server-world : 提供各種站台
郵件伺服器很麻煩
請goolge代管郵件

## FTP
1. 查詢軟體 : vftp
2. 安裝軟體
3. 服務設定 : 
4. 啟動服務 : systemctl enable --now
6. 防火牆設定 : firewall-cmd
5. 測試 : 

```sh
root# dnf install vsftpd

停止抓取extras-common
grep extras-common /etc/yum.repo.d/*
vim /etc/yum.repo.d/centos-addons.repo
###
[extras-common]
enable=0
###

多安裝幾次，拿到全部安裝
vim /etc/vsftpd/vsftpd.conf
###
啟動下列服務，刪除#註解
xferlog_file=/var/log/xferlog
idle_session_timeout=600
data_connection_timeout=120
###

systemctl enable --now vsftpd

sftp user@localhost
dnf ftp
ftp IP
###
[yes/footprint]
ftp> anomyous
password: [email@formate]
ls
exit
###

firewall-cmd --add-service=ftp
firewall-cmd --add-service=fip --permanent

UPLOAD
ftp> put file-path server-path
DOWNLOAD
ftp> get file-path your-path
```

ftp : 21-port 控制, 20-port 資料傳輸

## Email Server
DO NOT MANAGE IT

- DNS
- firewall
- auth 
- 評價 : 垃圾郵件評價
- data : 存放


- outlook/thunderbird:
    - `SMTP` : 25 port
    - send email to server
- Server
    - ask DNS whois 收件人
    - 設定只接收
    - 設定只發送
    - `SMTP` : 25 port to Destination Server
- 收信 server
    - cache, spool
- 收件者
    - delivery emails to user `POP3` : 110 port
    - 線上看信件 `IMAP` : 143 port

### MTA server
Postfix設定，針對伺服器收送郵件SMTP
送信與查詢

### MRA server
dovecot 設定，針對終端派送郵件
基礎 POP3/IMAP設定
加密 POP3s/IMAPs設定
防火牆

### 架設郵件服務

```sh
dnf sreach postfix
dnf install postfix -y

hostname
vim /etc/postfix/main.cf
###
myhostname = mail.student3.example.com
mydomain = student3.example.com
啟動或關閉註解
myorigin = $mydomain
int_nterfaces = all
#inet_interfaces = localhost
inet_protols = all
#mydestination = $myhostname, localhost.$mydomain, localhost
mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain
mynetworks_style = class
mynetworks = 10.10.53.0/24, 127.0.0.0/8
home_mailbox = Maildir/
###

systemctl enable --now postfix
systemctl status postfix
firewall-cmd --add-service=smtp
firewall-cmd --add-service=smtp --permanent

TEST
telnet localhost 25
220 mail.student3.example.com
quit

```

## gemini
在 vsftpd 中，要開放匿名使用者上傳檔案，你需要在設定檔 (`vsftpd.conf`) 中調整數個參數。單獨調整 `umask` 參數是不夠的，因為它只決定了上傳檔案的權限，而不影響匿名上傳的啟用。

`vsftpd.conf` 檔案通常位於 `/etc/vsftpd.conf` 或 `/etc/vsftpd/vsftpd.conf`。在修改之前，請務必先備份原始檔案。

-----

### 1\. 開啟匿名登入與上傳

確保你的設定檔中包含以下三行，這三行是開放匿名上傳的基礎。

```bash
# 允許匿名登入
anonymous_enable=YES

# 允許匿名使用者有上傳檔案的權限
anon_upload_enable=YES

# 允許匿名使用者建立目錄
anon_mkdir_write_enable=YES
```

  * **`anonymous_enable=YES`**：這是匿名登入的總開關。如果沒有它，其他匿名相關的設定都不會生效。
  * **`anon_upload_enable=YES`**：允許匿名使用者將檔案上傳到他們有寫入權限的目錄。
  * **`anon_mkdir_write_enable=YES`**：允許匿名使用者在這些目錄中建立子目錄。

-----

### 2\. 設定上傳目錄與權限

`vsftpd` 通常會將匿名使用者的家目錄設定在 `/var/ftp/` 或 `/srv/ftp/`。你需要確保這個目錄有正確的權限，讓匿名使用者能夠寫入。

```bash
sudo chown ftp:ftp /var/ftp/pub
sudo chmod 777 /var/ftp/pub
```

  * **`chown`**：將 `pub` 目錄的所有權設定為 `ftp` 使用者和群組。這是 vsftpd 預設用於匿名使用者帳號。
  * **`chmod`**：給予 `pub` 目錄讀取、寫入和執行的權限，以便匿名使用者可以上傳檔案。

**注意：** 最佳實踐是在 `/var/ftp/` 下建立一個子目錄（例如 `pub` 或 `incoming`）來開放上傳，而不是直接開放 `/var/ftp/` 本身，這樣可以更好地管理和隔離檔案。

-----

### 3\. 理解 umask 並正確設定

`umask` (user mask) 是一個用來**遮罩**檔案或目錄預設權限的數值。當你設定 `umask` 為 `022`，意思是：

  * **檔案**的預設權限是 `666`，遮罩掉 `022` 後變成 `644` (`rw-r--r--`)。
  * **目錄**的預設權限是 `777`，遮罩掉 `022` 後變成 `755` (`rwxr-xr-x`)。

這是一個標準且安全的設定，表示只有檔案擁有者能寫入，其他人都只能讀取和執行。

在 vsftpd 中，有兩種 umask 設定：

  * **`local_umask`**：用於**本地使用者**。
  * **`anon_umask`**：用於**匿名使用者**。

要讓匿名使用者上傳的檔案有特定的權限，你需要在設定檔中明確地加上或修改 `anon_umask` 參數。

```bash
# 設定匿名使用者上傳檔案和目錄的權限遮罩
anon_umask=022
```

這個設定會讓匿名使用者上傳的檔案權限為 `644`，目錄權限為 `755`。這是一個常見且合理的設定，它允許其他使用者讀取這些檔案，但只有檔案上傳者（`ftp` 帳號）可以修改或刪除它們。

### 總結與執行步驟

1.  **編輯** `vsftpd.conf` 檔案。
2.  確保 `anonymous_enable=YES`、`anon_upload_enable=YES` 和 `anon_mkdir_write_enable=YES`。
3.  （可選）新增或修改 `anon_umask=022`。
4.  **保存**並關閉檔案。
5.  **設定**上傳目錄的權限，例如 `/var/ftp/pub`：
    ```bash
    sudo chown ftp:ftp /var/ftp/pub
    sudo chmod 777 /var/ftp/pub
    ```
6.  **重啟** vsftpd 服務以應用新的設定：
    ```bash
    sudo systemctl restart vsftpd
    # 或
    sudo service vsftpd restart
    ```

完成這些步驟後，匿名使用者就可以登入並上傳檔案到你指定的目錄了。


## gemini 2
你的問題非常精準，它涉及到 `postfix` 服務與 `firewall-cmd` 指令的關係。簡單來說，`firewall-cmd --add-service=smtp` 這個指令之所以能開啟 `smtp` 服務，是因為 **`firewalld` 服務本身就預設了 `smtp` 服務所對應的通訊埠**，而不是因為它與 `postfix` 有直接關聯。

-----

### `firewalld` 的服務與通訊埠

`firewalld` 是一個動態防火牆管理工具，它將常見的網路服務和它們使用的通訊埠（port）預先定義為「服務」。這樣做的好處是，使用者不需要記憶每一個服務所對應的通訊埠號碼。

當你執行 `firewall-cmd --add-service=smtp` 時，`firewalld` 會在它的設定中查找 `smtp` 這個服務。`firewalld` 的服務定義檔通常位於 `/usr/lib/firewalld/services/` 或 `/etc/firewalld/services/` 目錄。

你可以查看 `smtp.xml` 這個檔案的內容來驗證：

```bash
cat /usr/lib/firewalld/services/smtp.xml
```

這個檔案的內容會類似這樣：

```xml
<?xml version="1.0" encoding="utf-8"?>
<service>
  <short>SMTP</short>
  <description>SMTP is used for sending e-mails between two hosts.</description>
  <port protocol="tcp" port="25"/>
</service>
```

從這個 XML 檔案可以看出，`smtp` 服務被定義為使用 **TCP 協定**的**通訊埠 25**。

-----

### Postfix 與 `firewalld` 的關係

`postfix` 是一個 MTA（Mail Transfer Agent），它負責處理郵件的發送和接收。當你安裝並啟動 `postfix` 後，它會預設在通訊埠 **25** 上監聽，等待接收和傳送郵件。

所以，當你執行 `firewall-cmd --add-service=smtp` 時，實際上是告訴防火牆：

1.  找到名為 `smtp` 的服務定義。
2.  發現 `smtp` 服務對應的是 **TCP 通訊埠 25**。
3.  在防火牆規則中，**開放所有進入通訊埠 25 的 TCP 連線**。

這就允許外部的郵件伺服器能夠連線到你主機的通訊埠 25，與 `postfix` 進行溝通，從而發送或接收郵件。

總結來說，`postfix` 和 `firewall-cmd` 是**兩個獨立的元件**，它們之間沒有直接的「認知」關係。`postfix` 只是碰巧使用 `firewalld` 已經預先定義好的 `smtp` 服務所對應的通訊埠。`firewalld` 是一個通用的工具，它定義了許多常見的服務，讓管理員可以透過服務名稱來操作防火牆，而無需記住每個服務的具體通訊埠號碼。