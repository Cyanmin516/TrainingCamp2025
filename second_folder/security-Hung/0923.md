# WireShark封包分析
- speacher: pro. Hung
- date: 2025-9-23
- class 7

#封包分析 #流量分析 #實務

## 實務上
* Q 網路網路不通
0. 回報網管
1. 網管與使用者都用traceroute 
    - 看網段，gateway
    - 實體問題或設定問題
2. 由上往下查交換機
    - L3 switch 檢查ARP
    - show mac table, 查MAC位址對應PORT
    - Cisco 可以連結所有硬體資訊
    - IP 分享器 NAT 查不到介接硬體
3. 啥時要封包分析
    - 網路問題排除的最後手段
4. 網路壅塞
    - 交換機 兩孔對接，形成迴圈
    - 拿到奇怪IP，網路孔被接上IP分享器LAN
5. 交換機設定Mirror Port
    - 流量複製到指定PORT
    - **流量分析就是減法，把不用的排除**
    - **server端port固定, 但client的port會亂跳**


1. 設定IP權限
    - IP衝突
    - 資產軟體監控與認證，Radius, AD認證
    - 認證
    - DHCP 無法查找
2. 網管亮點少
    - 不要把資安事件當指標，設備毀損與天災不可預測
    - 名詞老闆不懂 
    - 上班沒事就是研習

wirehark欄位順序
no, time, source, source port, destination, destination port, protocol, length , host ,info


三大交換機品牌:Cisco, Aruba, D-Link
C : 大型網路
A : 無線網路
D : 個人經濟方案

- 舊機台不安裝新韌體, 機台效能不構負擔
- https 需要憑證，憑證有效期限更短
- 架設企業VPN監控遠端，側錄行為
- VANS 資產盤點軟體


廠商介紹產品時，會介紹功能，但沒說要花多少資源達到目的

為何需要自己國家做通訊軟體，能備份能解密能監控

用port並不準確，所以封包解析行為

封包分析很吃經驗

### DDoS
低流量高負載，塞爆國際線路
數量X低流量X網路與子網路= 250 PC x 40 Mbps(影片) x class B and class C

流量清洗設備，放在防火牆前
流量型攻擊只能靠ISP業者清洗
服務型攻擊DDoS流量清洗設備放公司


## WireShark
- 錄製封包軟體，可選擇NIC與封包格式
- **硬體空間**需求跟流量錄製成正比


**欄位說明**
1. No 欄位:封包順序
2. Time欄位 : 時間
3. Source : 來源
4. Destination : 目的
5. Protocol : 標準協定
5. Length : 資料大小Bytes
6. Info : 其他訊息

**運算子**
| 關係 | 運算子 |
|:-|:-|
| 等於 | `==`, `Eq` |
| 不等於 | `!=`, `Ne` |
| 小於 | `>`, `Gt` |
| 大於 | `<`, `Lt` |


| 類型 |類型| 說明 | 範例 |
|:-|:-|:-|:-|
| eth | dst | 目的MAC | Eth.dst == ff:ff:ff:ff:ff:ff |
| |     src |來源MAC|   Eth.src == 01:23:24:ef:22:c8 |
| |     addr |MAC位址|  Eth.addr == 01:23:24:ef:22:c8 |
| |     type |下一層協定|Eth.type == 0x0800 (IP)  |
||||                    Eth.type == 0x0806 (ARP) |
| ip | dst     |目的IP| Ip.dst == 192.168.10.3 |
|| src |來源IP| Ip.src == 192.168.10.3 |
|| addr |IP位址| Ip.addr == 192.168.10.3 |
|| proto |下一層協定| Ip.proto == 0x06 (TCP) |
||||                       Ip.proto == 0x01 (ICMP) |
||||                       Ip.proto == 0x11 (UDP) |
**流量分析就是減法，把不用的排除**


| 類型 || 說明 | 範例 |
|:-|:-|:-|:-|
| tcp | dstport | 目的port | Tcp.dstport == 80 (HTTP) |
||      srcport | 來源port | Tcp.dstport == 21 (FTP) |
||      port    | 埠號     | Tcp.dstport == 23 (telnet) |
| ucp | dstport | 目的port | Udp.dstport == 53 (DNS) |
||      srcport | 來源port | Udp.dstport == 53 |
||      port    | 埠號     | Udp.dstport == 53 |


**server端port固定, 但client的port會亂跳**

### 流量分析 WireShark操作
用WireShark打開

統計Statistic 查詢
1. Endpoints : 查連線與流量
2. Conversation : 更詳細的點對點分析
3. protocol : 傳輸協定

Filter
0. 在protocol欄位右鍵, **apply as filter**, **select**
1. _ws.col.protocol="HTTP"
2. 奇怪的資料
3. `http contains "jndi"`

Info 
1. 右鍵info欄, follow => HTTP stream 看資料
2. 貼到cyberChef 解密
3. 拿到攻擊碼
4. 是遠端執行控制攻擊命令

排查
1. 查endpoints
2. 服務port固定是server
3. filter telnet
4. follow TCP stream
    - 點任意資料背景會跳對應封包
    - 紅色 使用者
    - 藍色 使用者

**Base64** : 句尾會是 `=` 或是 `==`

host 顯示主機
- 選取一個攻擊HTTP
- HyperText
- Get
- Host
- Apply as Column

顯示port
- 選取一個L4封包
- Transmission Control protocol
- source port, apply as column
- destination port, apply as column
- 習慣上port放IP後面, source IP, source Port, destination IP, destination Port

source IP > 右鍵 Apply as filter > And Select
edit time > UTC-YYYY:MM:DD:SS and time

顯示
紅底, RST ACK
黑底, TCP 重新傳遞
灰底, SYN 封包

### mta2.pcap
file > export objects > HTTP

### lab01
Q1. who is 192.168.0.1
server, 
Q1. who is 192.168.0.2
user
Q1. How to login 192.168.0.1 
fake/user
Q4. What they do
OpenBSD
bam.zing.org
PING www.yahoo.com (204.71.200.67): 56 data bytes
/sbin/ping www.yahoo.com
ls

1. 查endpoints
2. 服務port固定是server
3. filter telnet
4. follow TCP stream
    - 點任意資料背景會跳對應封包
    - 紅色 使用者
    - 藍色 使用者

```sh
/sbin/ping www.yahoo.com
ls
ls -a
exit
```
### lab 02
10.100.25.14對10.100.18.12 掃描port 伺服器
3s掃完29個port

15.236.229.88 伺服器
收到99個連線0.016秒內
338MBps 請求

SYN flood大量請求服務
DoS 阻斷服務
DDoS分散式阻斷服務

### lab03
MIME-Version: 1.0
Content-Type: text/x-msmsgscontrol
tesla_brian@hotmail.com Brian
tesla_thomas@hotmail.com Thomas

```
Hey Brian
Hey man, whats up?
Not much, did you hear about the new IT guy they hired?
ohh yea, i hear he is a real jerk
I've heard the same
maybe we should try hacking into a server to mess with him?
sounds good to me
```

### lab04
10.121.70.151 FTP server
10.234.125.254 client
USER admin
login 
USER administrator
login
530 login incorrect

過濾出使用者try
source > 右鍵 filter > and select

### lab05
Q1. TCP/6346 program
Q2. how many links to 10.1.4.176
Q3. How many likns succesful linked to 10.1.4.176


A1. Gnutella   
A2. 81 IPs
statitics > conversations
A3. 2 IPs
protocol > Apply as filter

IP 65.34.1.56 
[Calculated window size: 8404]
IP 213.66.32.81
[Calculated window size: 8690]



### lab06
Q. Jim can not surf Internet but Risa can.
- Risa
```
Ethernet II, Src: Microsoft_2a:45:d2 (00:03:ff:2a:45:d2), Dst: DLink_21:99:4c (00:05:5d:21:99:4c)
Internet Protocol Version 4, Src: 192.168.0.183, Dst: 64.233.161.104
```
- Jim
```
Ethernet II, Src: Microsoft_2a:45:d2 (00:03:ff:2a:45:d2), Dst: Broadcast (ff:ff:ff:ff:ff:ff)
```
student ans:MAC仿造

1. Risa  
廣播ARP, IP and MAC 
拿到回應

2. Jim
沒拿到gateway


### lab07
what they did?
What name is the Attack? bash env

1. select HTTP
2. follow, HTTP stream

echo Content-type:text/plain;echo;/bin/cat /etc/passwd

- 用cat 查詢passwd

風險最高，任意程式碼執行



### lab08

HTTP
attacker 192.168.43.200
victim  192.168.43.120
Attack name `apache struts`
what he did?
open webshell remote full control
cat /etc/passwd

1. HTTP , apply as select
2. sort Info
    - 找到奇怪的 webshell.php
3. 找奇怪的請求(像亂碼%=)
4. Follow, HTTP Stream
    - CyberChef
    - 解密
5. 依序追查
    - 


### lab09

1. sort protocol. : DNS, HTTP, FTP, TCP
2. 抓奇怪Info
    - follow HTTP stream 
    - 帳號密碼傳到其他主機(用奇怪參數傳遞)

### lab10
1. post data 
2. 查大小, 不正常的HTTP POST
3. cyberChef, base64

惡意伺服器透過base64傳遞資料

