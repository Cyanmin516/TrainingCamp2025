# switch
- speacher: pro. Chen
- date: 2025-8-8
- class 11
- CCNA2 chapter 3.4 vlan trunk
- chapter 4

#vlan #trunk #access #trunk #switchCMD #邏輯隔離且實體線路共用 #Voice #DTP #nonegotiate #route_vlan #encapsulation_dot1q_VID

## VLAN Tag Field Details
As shown in the figure, the VLAN tag control information field consists of a Type field, a Priority field, a Canonical Format Identifier field, and VLAN ID field:

- **Type** - A 2-byte value called the tag protocol ID (TPID) value. For Ethernet, it is set to hexadecimal 0x8100.
- **User priority** - A 3-bit value that supports level or service implementation.
- **Canonical Format Identifier (CFI)** - A 1-bit identifier that enables Token Ring frames to be carried across Ethernet links.
- **VLAN ID (VID)** - A 12-bit VLAN identification number that supports up to 4096 VLAN IDs.

![Vlan](vlan.png)
vlan 依照標籤轉送, 12bit VID=4096

- `1-1005` vlan 標準通訊
- `1006-4095` 企業使用
- Cisco設備 預設一個終端PORT只綁一個vlan

VLAN Name                             Status    Ports
---- -------------------------------- --------- -------------------------------
1    default                          active    all ports
1002 fddi-default                     active    
1003 token-ring-default               active    
1004 fddinet-default                  active    
1005 trnet-default                    active    

## VLAN trunk
- **所有交換機**在兩端之間必須相同`vlan編號`及允許`trunk`設定
- 對終端port綁定Vlan限制存取無法ping到同網段其他設備
- 不同廠牌trunk協商不穩定，手動設定為佳
- 將預設 VLAN 從 VLAN 1 更改為 VLAN 99，是為了將重要的網路管理流量與使用者流量隔離，並增加攻擊者發動攻擊的難度，從而提升整個網路的安全性。
- **安全性**，當未標記封包經過一台預設vlan99的交換機，封包會自動標記，導致無法正常接收。所以交換機之間會有CDP溝通native trunk.
- VLAN 透過 Trunk 技術，完美地實現了「**邏輯隔離**」與「**實體線路共用**」這兩個看似矛盾的目標。這也是 VLAN 在現代企業網路中如此重要的原因。

| 名詞 | 解釋 |
|:-|:-|
| VLAN | 提供相同VID的裝置連線，預設VLAN 1 |
| MAC | 轉發封包SrcMAC到DesMAC |
| switchport mode access | 交換機對工作端，阻隔其他VLAN廣播 |
| switchport mode trunk | 交換機與交換機通道 |
| switchport trunk native | 更改預設VLAN防護未標籤封包汙染 |

### switch setting
交換機對交換機
```console
修改預設的VLAN
S1(config)# interface fastEthernet 0/1
S1(config-if)# switchport mode trunk
S1(config-if)# switchport trunk native vlan 99
S1(config-if)# switchport trunk allowed vlan 10,20,30,99
S1(config-if)# end


S1# show interfaces fa0/1 switchport

    手動設定模式(dynamic/trunk/static)
administrative Mode: trunk
    現在運作模式()
Operational Mode: trunk
    准許的VLAN

    協定802.1Q 用英文取代數字
Administrative Trunking Encapsulation: dot1q
    協定802.1Q 用英文取代數字
Operational Trunking Encapsulation: dot1q
Trunking VLANs Enabled:
    過濾(1是標準預設使用)
Pruning VLAN Enalbe:2-1001
```

### example
```
show vlan brief
列出所有vlan群組

show interface trunk
找trunk通道

S1(config-if)# no ip address
不用參數直接取消

show interface status
交換機確認實體 port 與 vlan 設定

vlan 1 預設關閉，要no shutdown啟動
其他vlan 預設啟動

若指定到空的vlan會自動建立該vlan
VLAN0030

但直接刪除該vlan會導致原本的port失去vlan0030且沒有預設vlan

S1(config-if)#switchport mode dynamic desirable 
只下dynamic會是auto被動
加入選項 desirabe 後成為主動配合的trunk

no switchport access vlan
更改此port的vlan到預設值

雙方Native vlan不同時，衝突每 30 s 發訊息
S1(config-if)#
%CDP-4-NATIVE_VLAN_MISMATCH: Native VLAN mismatch discovered on FastEthernet0/1 (1000), with S2 FastEthernet0/1 (1).

通道選項
S1(config-if)#switchport trunk ?
    allowed  Set allowed VLAN characteristics when interface is in trunking mode
    native   Set trunking native characteristics when interface is in trunking mode
```


## Vlan DTP
Cisco設備預設協定, 30s溝通一次DTP, 300s中斷trunk
- S1(config-if)# switchport nonegotiate
- Switch(config-if)# switchport mode {  access | dynamic {  auto | desirable } |  trunk }

| 1\2           | **Dynamic auto** | **Dynamic desirable**  | **Trunk** | **Access** |
|:-|:-|:-|:-|:-|
| **Dynamic auto**  | Access        | Trunk             | Trunk | Access |
| **Dynamic Desirable** | Trunk | Trunk | Trunk | Access |
| **Trunk** | Trunk | Trunk | Trunk | *limited connectivity* |
| **Access** | Access | Access | *limited connectivity* | Access | 


### samples 3.6.1
建立vlan
IP 綁 Vlan
先進入f0/1後 設定 Access 綁vlan
先進入g0/1後 設定 Trunk 綁Native vlan 且 nonegotiate(切到trunk時會啟用)
測試其他模式

(config)#vlan 10
(config-vlan)#name Admin
 
SWC(config)#interface f0/4
SWC(config-if)#switchport voice vlan 40
SWC(config-if)#mls qos trust cos
SWC(config-if)#switchport mode access 
SWC(config-if)#switchport access vlan 10

SWA(config)#interface g0/1
SWA(config-if)#switchport mode trunk 
SWA(config-if)#switchport nonegotiate 
SWA(config-if)#switchport trunk native vlan 100

SWC(config)#interface vlan 99
SWC(config-if)#ip address 192.168.99.254 255.255.255.0
 

 ## 4.1.1 What is Inter-VLAN Routing?
 There are three inter-VLAN routing options:

- **Legacy Inter-VLAN routing** - This is a legacy solution. It does not scale well.
- **Router-on-a-Stick** - This is an acceptable solution for a small to medium-sized network.
- **Layer 3 switch using switched virtual interfaces (SVIs)** - This is the most scalable solution for medium to large organizations.

單臂路由
R1 Subinterfaces
G0/0/0.10: 172.17.10.1 [VLAN 10]
G0/0/0.20: 172.17.20.1 [VLAN 20]
G0/0/0.30: 172.17.30.1 [VLAN 30]
紀錄方法在介面卡後墜加.vlan

第三層交換器
有能力轉換訊框，可安裝加速卡


### sample 4.2.7
R1(config)# interface G0/0/1.10
R1(config-subif)# description Default Gateway for VLAN 10
R1(config-subif)# encapsulation dot1Q 10
R1(config-subif)# ip add 192.168.10.1 255.255.255.0
R1(config-subif)# interface g0/0
R1(config-subif)# no shutdown

## 課後補充
### switch Access and Trunk
交換機的 VLAN 連接模式概要
-	**Access Mode**：
	-	每個 Access Port 只能屬於一個 VLAN。
	-	進入的無標籤封包會被打上該 VLAN 的標籤 (VID)。
	-	傳出的封包會移除 VLAN 標籤，送給終端裝置。

-	**Trunk Mode**：
	-	可同時傳輸多個 VLAN 的封包。
	-	已有 VLAN 標籤的封包會檢查 VID 再轉發。
	-	無標籤封包會被套用 Native VLAN 標籤。

### Native 

會出現兩條 Trunk 但 Native VLAN ID 不同的需求，通常是這幾種情境：
1.	**跨網段的管理或隔離需求**
    -	有些網管會把不同交換機之間的管理介面放在不同 VLAN，例如一組設備的管理用 VLAN 10，另一組用 VLAN 20。
    -	雖然兩條 Trunk 都承載多個 VLAN，但因為管理端口的 Native VLAN 不一樣，便於設備在沒有 VLAN 標籤的情況下，也能正確進入對應的管理網段。
2.	**降低 Native VLAN 衝突風險**
    -	若 Trunk 連到不同廠商或不同部門的交換機，Native VLAN ID 不一致可以避免「未標籤封包」誤進錯的 VLAN。
    -	這常見於兩個網路區塊交界的連接線，讓未標籤封包不會自動混到同一 VLAN。
3.	**漸進式 VLAN 重構或遷移**
    -	網路在改版時，部分 Trunk 先改成新的 Native VLAN，而舊系統還用舊的 Native VLAN。
    -	這樣可以逐步遷移，不會一次影響全部連線。
4.	**應對不同用途的鏈路**
    -	例如一條 Trunk 專門服務語音 VLAN（Native 設為語音 VLAN），另一條專門服務監控 VLAN。
    -	這樣可以讓某些特定未標籤流量自動進入正確用途的 VLAN，而不用在端口端手動打標籤。

