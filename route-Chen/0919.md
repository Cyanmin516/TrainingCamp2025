# 路由
- speacher: pro. Chen
- date: 2025-9-19
- class 16
- CCNA2 chapter 14 Routing Concept
- CCNA2 chapter 15 IP static routing
- CCNA2 chapter 15 靜態路由和封包轉發

#實務 #routing #OSPF #BGP #動態路由 #靜態路由 #next_hop #AD/度量 #浮動靜態路由


## 實務上
任何組態都要留檔
業務上可能會出現客戶需要緊急修復需求like停電、淹水、維修。
網管一定要知道的，網路架構圖，介面，設定檔，伺服器管理帳號檔案或找到承辦人。

TWNIC:申請台灣IP、ASN(多重路由分享)

手動設定路由表時，指綁介面不指定IP會出錯

ping 不通改用tracert

## 路由器路由
依照路由表查詢轉送位址

- 最長匹配(**必考**) : IP相同時，優先選擇**遮罩**最長的


1. 直連網路 : 當port狀態UP才會學習
2. 遠端網路 : 靜態路由=手動設定;或是通過協定`EIGRP`、`OSPF`等來新增。
3. 預設路由 : 不符合路由表都往這個介面，IPv4=`0.0.0.0`; IPv6=`::0`; 
 
沒設定`預設路由`，當查表失敗就`丟棄`。

交換器則是廣播(除了來源介面)傳遞。

### 封包轉送
- 程序交換 : CPU查表
- 快速交換 : 利用快取只處理
- CEF : Cisco研發 快取晶片，CPU來處理設定組態。

2000年以後 都配置快取

PS `設備商Juniper`功能晶片都分開，大規模企業級路由器。

#### sample route
```sh
Router> enable
Router# configure terminal
Enter configuration commands, one per line. End with CNTL/Z.
Router(config)# hostname R1
R1(config)# enable secret class
R1(config)# line console 0
R1(config-line)# logging synchronous
R1(config-line)# password cisco
啟動本機登入檢查
R1(config-line)# login
R1(config-line)# exit
R1(config)# line vty 0 4
R1(config-line)# password cisco
啟動本機登入檢查
R1(config-line)# login
R1(config-line)# transport input ssh telnet
R1(config-line)# exit
R1(config)# service password-encryption
R1(config)# banner motd #
Enter TEXT message. End with a new line and the #
***********************************************
WARNING: Unauthorized access is prohibited!
***********************************************
#
預設關閉，手動啟用
R1(config)# ipv6 unicast-routing
交換機是ip routing
R1(config)# interface gigabitethernet 0/0/0
R1(config-if)# description Link to LAN 1
R1(config-if)# ip address 10.0.1.1 255.255.255.0
R1(config-if)# ipv6 address 2001:db8:acad:1::1/64
R1(config-if)# ipv6 address fe80::1:a link-local
R1(config-if)# no shutdown
R1(config-if)# exit
R1(config)# interface gigabitethernet 0/0/1
R1(config-if)# description Link to LAN 2
R1(config-if)# ip address 10.0.2.1 255.255.255.0
R1(config-if)# ipv6 address 2001:db8:acad:2::1/64
R1(config-if)# ipv6 address fe80::1:b link-local
R1(config-if)# no shutdown
R1(config-if)# exit
R1(config)# interface serial 0/1/1
R1(config-if)# description Link to R2
R1(config-if)# ip address 10.0.3.1 255.255.255.0
R1(config-if)# ipv6 address 2001:db8:acad:3::1/64
R1(config-if)# ipv6 address fe80::1:c link-local
R1(config-if)# no shutdown
R1(config-if)# exit
非常重要，定期存檔
R1# copy running-config startup-config
Destination filename [startup-config]?
Building configuration...
[OK]
R1#
```



查修常用指令
```sh
關鍵字搜尋word? 
tab自動補全
停止錯誤指令查找
no ip domain-lookup

show version
show ip interface brief 
show ipv6 interface brief
show interfaces
查input使用率
查received廣播應該要占比10%以下: arp, DHCP; runts太小封包、giants太大封包
現在multicast比例高:直播觀看需求

show ipv6 interface
FF02::1 所有ipv6內設備 
FF02::2 所有ipv6路由

show ip route
C=網域 L=終端 S=靜態 O=OSPF協定 *=預設路由
C 10.10.10.0/24 GigabitEthernet 0/0
L 10.10.10.99/32 GigabitEthernet 0/0
L ff00::/8
預設丟棄

使用接續pipe |
secion
include
begin
exclude

| section line vty
| include up
| exclude unassigned
show ip route| begin Gateway
```



### R2 sample
```sh
enable secret c1sco1234
ip domain-name ccna-lab.com
service password-encryption
username SSHadmin secret 55Hadm!n

crypto key generate ras
[1024]

line console 0
password cisco
login
exec-timeout 6
logging synchronous

line vty 0 4
password cisco
使用本地認證;login authentication 是第三方驗證
login local
transport input ssh
exec-timeout 6

banner motd "Warning"
ipv6 unicast-routing

PC3- command prompt
ssh -l SSHadmin

interface g0/0/1 
ip address 209.165.200.225 255.255.255.252
ipv6 address 2001:db8:feed:224::1/64
ipv6 address fe80::1:d link-local
no shutdown


[PC]
command prompt 
ssh -l <username> <remoteIP>
```

### 條目
IPv4
- 標籤, IP/mask, AD值/度量值 數值小優先, 路由, 時間，介面
- O | 10.0.4.0/24 | AD值 | via 10.0.3.1 | 10:03:47 | Serial 0/1


### 靜態路由
stub : 路由末端，只有一條對外網路

R1# show ip route static

### 路由表結構
| Class A | Class B | Class C |
|:-|:-|:-|
|bitstart 01  | 10 | 110 |
| /8 | /16 | /24 |
| 0-127 | 128-191 | 192-223 |


### 管理距離 Administrative Distance
優先權，數值小優先

| 協定 | 優先權| 
|:-|:-|
| 內部EIGRP | 90 |
| OSPF | 110 |
| RIP | 120 |
| 直連 | 0 |
| 手動設定 | 1 |

### 動態路由
- 多個路由器組成的網路
- 網路拓樸中的變動需要網路自動決定路徑(多重路徑時)
- 網路成長，


## 14.5.1 比較動態靜態路由
| 功能 | 動態路由 | 靜態路由 |
|:-|:-|:-|
| 設定複雜性 | 網路大小無關 | 隨網路變大 |
| 拓樸變化 | 簡單到複雜都適合 | 簡單拓樸 |
| 安全 | 必須設定安全性 | 安全性是固有的 |
| 資源使用率 | CPU | 較少 |
| 變化 | 隨時會改變 | 固定 |

### 演算法
OSPF : 路由表學習
IS-IS : 中間系統對接
IGRP/EIGRP : 內部閘道路由協定/增強行IGRP，為思科專利
**BGP** : 邊界閘道協定，不同組織不同路由網域

### 協定
常見使用

| 網路 | 內部閘道 | | 外部閘道協定 |
|:-|:-|:-|:-|
| | 距離向量 | 鏈路狀態 | 路徑向量 |
| IPv4 | RIPv2, EIGRP | OSPFv2, IS-IS | BGP-4 | 
| IPv6 | RIPng, EIGRP(IPv6) | OSPFv3, IS-IS(IPv6) | BGP-MP |

**動態路由**
- 資料結構
- 路由協定訊息
- 演算法

**度量**
- RIP : 跳躍點數量<16
- OSPF : 成本，比較數值小
- EIGRP : 頻寬+延遲+負載+可靠性


## 15 靜態路由
**Next-hop route** - Only the next-hop IP address is specified

**Directly connected static route** - Only the router exit interface is specified

**Fully specified static route** - The next-hop IP address and exit interface are specified

雙堆疊路由表，同時支援IPv6 IPv4路由

```sh
靜態路由指定 IPv4
Router(config)# ip route network-address subnet-mask { ip-address | exit-intf [ip-address]} [distance]

靜態路由指定 IPv6
Router(config)# ipv6 route ipv6-prefix/prefix-length {ipv6-address | exit-intf [ipv6-address]} [distance]
```

### IPv4 next-hop route
```sh
R(config)# ip route 172.16.1.0 255.255.255.0 172.16.2.2

sh
ipv6 unicast-routing
ipv6 route 2001:db8:acad:8::/64  2001:db8:acad:8::1

ip route 172.16.1.0 255.255.255.0 GigabitEthernet 0/0/0
不會有度量值
不顯示靜態路由

ipv6 route 2001:db8:acad:1::/64 s0/1/0
S   2001:DB8:ACAD:1::/64 [1/0]
     via Serial0/1/0, directly connected


ip route <ip> <mask> <interface> <next ip>
ipv6 route <ip/len> <interface> <link-local>


show ip route static | begin Gateway
show ipv6 static
```
 
### 15.3.2 預設路由
```sh
ip route 0.0.0.0 0.0.0.0 { ip | interface }
ipv6 rout ::/0 {IP}
```

### 15.4.1 浮動靜態路由
**浮動靜態路由** : 更改度量值，數值小優先，讓備援通道接續工作
[AD協定方式/度量值]
```sh
ip route 0.0.0.0 0.0.0.0 172.16.2.2 2
ip route 0.0.0.0 0.0.0.0 10.10.10.2 5
ipv6 route ::/0 2001:DB8:CAFE:2::1
ipv6 route ::/0 2001:DB8:breed:3::10 5
show ip route
show ipv6 route
```
路由表僅顯示最優先介面IP,備援的隱藏

### 15.5.6 設定IPv6靜態主機路由器使用鏈路本地下一個跳躍點
對照順序
1. 只看目的地IP/network
2. 遮罩**最長**
3. AD值**最小**
4. 度量值**最小**

主機路由
```sh
ip route IP 255.255.255.255 <nextRouteIPv4>
ipv6 route IP/128 <nextRouteIPv6>
```

### 16 靜態路由與封包轉發
ping 不通，改用tracert

#### sample 16.3.1
tracert PC1 to PC2 

show running-config

```sh
ip classless
這個是IPv4路由
ip route 0.0.0.0 0.0.0.0 172.31.1.195 
!
ip flow-export version 9
!
這是IPv6路由
ipv6 route 2001:DB8:4::/64 Serial0/0/0
ipv6 route 2001:DB8:3::/64 Serial0/0/0
ipv6 route 2001:DB8:5::/64 Serial0/0/0
!
!
```


line vty 0 4
login local
login authentication
負責認證的主機通常稱為**認證伺服器** (Authentication Server)。
---

常見的認證伺服器協定包括：

* **RADIUS (Remote Authentication Dial-In User Service)**：一個集中式的網路認證、授權和帳務管理 (AAA) 協定，廣泛用於 Wi-Fi 熱點、VPN 和網路存取控制。
* **TACACS+ (Terminal Access Controller Access-Control System Plus)**：主要用於管理網路設備（如 Cisco 路由器和交換器）的認證、授權和帳務管理。
* **LDAP (Lightweight Directory Access Protocol)**：雖然主要是一個目錄服務協定，但它也常被用來作為認證的後端資料庫，例如使用者帳號和密碼的儲存。

這些伺服器集中管理使用者資訊，讓網路設備（如路由器）不需要各自儲存帳號密碼，只需要向這些伺服器發出認證請求即可。

在 **SWITCH** 網路中，將多條網路線聚合起來，並使用相同的 IP 與 VLAN，這種技術的英文縮寫是 **LACP**。

---

### 什麼是 LACP？

**LACP** (Link Aggregation Control Protocol) 是一種 IEEE 802.3ad 標準，用於將多個實體網路介面（Port）捆綁成一個邏輯介面，以達到以下目的：

* **頻寬增加**：將多條網路線的頻寬加總，例如將兩條 1Gbps 的網路線聚合，可提供 2Gbps 的頻寬。
* **高可用性**：如果其中一條網路線或一個 Port 故障，流量會自動轉移到其他正常運作的線路上，確保網路不中斷。
* **負載平衡**：將流量分散到不同的實體線路上，以提高網路效能。

簡單來說，LACP 就像是把多條網路線綁成一條「更粗、更穩定」的線路，讓你的設備能有更高的傳輸效能和更好的備援能力。